<!-- 
	WebAR_test_15

	
	

	ソースコードを参考にGLTF形式の3Dモデルを取り込み表示
	hittest
	平面を検知して、画面をタップした時に、サークルの位置に3Dモデルが表示される
	タップしたら表示され、前の物は消える → 移動しているように見せる

	r11:複数種類の3Dモデルを表示(ボタンで切換)
			(smallはタップした分生成、mediumはタップするごとに移動)

	切替ボタンがARカメラの映像で隠れてしまう、映像の上に重ねたい


	r12:
	13:モデル二つの表示非表示をそれぞれボタンで制御
	14:モデルの明るさ変更(モデル2のみ)
	15:overlay1の高さがタッチの前後で変化してしまうため、修正中
  16:ミス
	17:




	main.cssコメントアウト

	ソースコード
	https://github.com/mrdoob/three.js/blob/master/examples/jsm/webxr/ARButton.js
	


	・複数の3Dモデルを表示する場合
	3Dファイルを用意します。
	loadModel()関数を複製し、新しい関数を作成します。例えば、loadModel2()という関数を作成します。
	複製した関数内のloader.load()メソッドの第1引数に、新しい3Dファイルのパスを指定します。
	複製した関数内のscene.add()メソッドの引数に、新しいモデルを追加します。
	新しい関数を呼び出すためのイベントリスナーを設定します。例えば、controller.addEventListener('select', loadModel2);というようにします。


	
-->



<!-- 
	WebAR_test_9

	ソースコードを参考にGLTF形式の3Dモデルを取り込み表示
	hittest
	平面を検知して、画面をタップした時に、サークルの位置に3Dモデルが表示される
	タップしたら表示され、前の物は消える → 移動しているように見せる

	ソースコード
	https://github.com/mrdoob/three.js/blob/master/examples/jsm/webxr/ARButton.js
	
-->




<!DOCTYPE html>
<html lang="en">

<head>
	<title>15 three.js ar - hit test</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<link type="text/css" rel="stylesheet" href="main.css">
</head>

<body>


	<!-- 不要 -->
	<!-- <div id="info">
			<a href="https://threejs.org" target="_blank" rel="noopener">three.js</a> ar - hit test<br/>(Chrome Android 81+)
		</div>
 -->
	<!-- Import maps polyfill -->
	<!-- Remove this when import maps will be widely supported -->
	<!-- <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script> -->



	<script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>




	<!--  importmapと一緒に使用し、three.module.jsをimportするため -->
	<script type="importmap">
			{
				"imports": {
					"three": "https://unpkg.com/three/build/three.module.js"
				}
			}
		</script>


	<script type="module">

		// importmapと一緒に使用し、three.module.jsをimportするため
		import * as THREE from 'three';
		// 上記と同じ内容
		// import * as THREE from "https://unpkg.com/three/build/three.module.js";



		// import * as THREE from './three.module.js';  // ファイルパスを正確に指定する

		// GLTFファイル使用用
		import { GLTFLoader } from './GLTFLoader.js';

		// import { ARButton } from 'three/addons/webxr/ARButton.js';
		import { ARButton } from './ARButton.js';



















    
    let renderer, scene, camera, xrSession, xrRefSpace, xrHitTestSource;



    init();
function init() {
  renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);
  renderer.xr.enabled = true;
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
  scene.add(camera);

  // モデルを読み込む
  const loader = new GLTFLoader();
  loader.load('model.glb', (gltf) => {
    gltf.scene.visible = false; // 最初は非表示に
    scene.add(gltf.scene);
    renderer.setAnimationLoop(render);
  });

  // arセッションを開始
  document.getElementById('ar-button').addEventListener('click', onARButtonClick);
}

async function onARButtonClick() {
  xrSession = await navigator.xr.requestSession('immersive-ar', {
    requiredFeatures: ['hit-test'],
  });

  xrSession.addEventListener('select', onSelect); // タッチイベントリッスン
  renderer.xr.setSession(xrSession);

  const referenceSpace = await xrSession.requestReferenceSpace('local');
  xrRefSpace = referenceSpace;
  xrHitTestSource = await xrSession.requestHitTestSource({ space: referenceSpace });
}

// タッチした座標でhitTest
function onSelect(event) {
  const frame = event.frame;
  const viewerPose = frame.getViewerPose(xrRefSpace);
  
  if (viewerPose) {
    const hitTestResults = frame.getHitTestResults(xrHitTestSource);

    // hit test結果がある場合、その位置にオブジェクトを配置
    if (hitTestResults.length > 0) {
      const hit = hitTestResults[0];
      const hitPose = hit.getPose(xrRefSpace);

      // オブジェクトの位置をタッチした位置に設定
      const model = scene.children.find(obj => obj.type === 'Group'); // 読み込んだモデルの参照を取得
      model.position.set(hitPose.transform.position.x, hitPose.transform.position.y, hitPose.transform.position.z);
      model.visible = true;
    }
  }
}

// 描画ループ
function render() {
  renderer.render(scene, camera);
}



	</script>
</body>

</html>