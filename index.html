<!-- 
	WebAR_test_17

	
	

	ソースコードを参考にGLTF形式の3Dモデルを取り込み表示
	hittest
	平面を検知して、画面をタップした時に、サークルの位置に3Dモデルが表示される
	タップしたら表示され、前の物は消える → 移動しているように見せる

	r11:複数種類の3Dモデルを表示(ボタンで切換)
			(smallはタップした分生成、mediumはタップするごとに移動)

	切替ボタンがARカメラの映像で隠れてしまう、映像の上に重ねたい


	r12:
	13:モデル二つの表示非表示をそれぞれボタンで制御
	14:モデルの明るさ変更(モデル2のみ)
	15:overlay1の高さがタッチの前後で変化してしまうため、修正中
  16:ミス
	17:




	main.cssコメントアウト

	ソースコード
	https://github.com/mrdoob/three.js/blob/master/examples/jsm/webxr/ARButton.js
	


	・複数の3Dモデルを表示する場合
	3Dファイルを用意します。
	loadModel()関数を複製し、新しい関数を作成します。例えば、loadModel2()という関数を作成します。
	複製した関数内のloader.load()メソッドの第1引数に、新しい3Dファイルのパスを指定します。
	複製した関数内のscene.add()メソッドの引数に、新しいモデルを追加します。
	新しい関数を呼び出すためのイベントリスナーを設定します。例えば、controller.addEventListener('select', loadModel2);というようにします。


	
-->



<!-- 
	WebAR_test_9

	ソースコードを参考にGLTF形式の3Dモデルを取り込み表示
	hittest
	平面を検知して、画面をタップした時に、サークルの位置に3Dモデルが表示される
	タップしたら表示され、前の物は消える → 移動しているように見せる

	ソースコード
	https://github.com/mrdoob/three.js/blob/master/examples/jsm/webxr/ARButton.js
	
-->




<!DOCTYPE html>
<html lang="en">

<head>
	<title>17 three.js ar - hit test</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<link type="text/css" rel="stylesheet" href="main.css">
</head>

<body>


	<!-- 不要 -->
	<!-- <div id="info">
			<a href="https://threejs.org" target="_blank" rel="noopener">three.js</a> ar - hit test<br/>(Chrome Android 81+)
		</div>
 -->
	<!-- Import maps polyfill -->
	<!-- Remove this when import maps will be widely supported -->
	<!-- <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script> -->



	<script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>




	<!--  importmapと一緒に使用し、three.module.jsをimportするため -->
	<script type="importmap">
			{
				"imports": {
					"three": "https://unpkg.com/three/build/three.module.js"
				}
			}
		</script>


	<script type="module">

		// importmapと一緒に使用し、three.module.jsをimportするため
		import * as THREE from 'three';
		// 上記と同じ内容
		// import * as THREE from "https://unpkg.com/three/build/three.module.js";



		// import * as THREE from './three.module.js';  // ファイルパスを正確に指定する

		// GLTFファイル使用用
		import { GLTFLoader } from './GLTFLoader.js';

		// import { ARButton } from 'three/addons/webxr/ARButton.js';
		import { ARButton } from './ARButton.js';





		let container;
		let camera, scene, renderer;
		let controller;

		let reticle;

		let hitTestSource = null;
		let hitTestSourceRequested = false;



		// ARButton クラスのインスタンスを作成
		// const arButton = new ARButton();
		let arButton;

		arButton = new ARButton();




    // //新
    // // タッチ位置を3D空間に変換する関数
    // function getTouchPosition(touch) {
    //     const rect = renderer.domElement.getBoundingClientRect();
    //     const x = ((touch.clientX - rect.left) / rect.width) * 2 - 1;
    //     const y = -((touch.clientY - rect.top) / rect.height) * 2 + 1;

    //     // 2D座標を3D座標に変換
    //     const vector = new THREE.Vector3(x, y, 0.5); // zは適当な値
    //     vector.unproject(camera); // カメラからワールド座標に変換

    //     const dir = vector.sub(camera.position).normalize(); // カメラからの方向を計算
    //     const distance = -camera.position.z / dir.z; // z=0での交点を計算
    //     const position = camera.position.clone().add(dir.multiplyScalar(distance)); // 交点の計算

    //     // タッチ位置をコンソールに表示
    //     console.log('タッチ位置:', touch.clientX, touch.clientY); // スクリーン座標を表示
    //     console.log('ワールド座標:', worldPosition); // 3D空間の位置を表示

    //     return position;
    // }










		// 関数読み込み
		init();
		animate();


		function init() {
			
			container = document.createElement('div');
			document.body.appendChild(container);

			scene = new THREE.Scene();

			camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

			const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
			light.position.set(0.5, 1, 0.25);
			scene.add(light);

			//
			renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
			renderer.setPixelRatio(window.devicePixelRatio);
			renderer.setSize(window.innerWidth, window.innerHeight);
			renderer.xr.enabled = true;
			container.appendChild(renderer.domElement);




			// ARカメラ起動ボタン
			document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] }));

			//
			const geometry = new THREE.CylinderGeometry(0.1, 0.1, 0.2, 32).translate(0, 0.1, 0);

		}





    

		function onWindowResize() {

			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();

			renderer.setSize(window.innerWidth, window.innerHeight);

		}

		//
		function animate() {

			renderer.setAnimationLoop(render);

		}
	</script>
</body>

</html>