
<!-- 
タッチした場所にオブジェクト移動
失敗


-->




<!DOCTYPE html>
<html lang="en">
<head>
    <title>Simple AR Example</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
</head>
<body>
    <!-- ESモジュールを使用するためのスクリプト -->
    <script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>
    
    <!-- Three.js と GLTFLoader のインポートマップ -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three/build/three.module.js",
                "GLTFLoader": "https://unpkg.com/three/examples/jsm/loaders/GLTFLoader.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three'; // Three.jsライブラリをインポート
        import { GLTFLoader } from 'GLTFLoader'; // GLTFローダーをインポート
        import { ARButton } from './ARButton.js';

        let scene, camera, renderer, controller, hitTestSource = null;
        let redDot, model; // 赤点とモデル用の変数

        init(); // 初期化関数を呼び出し
        animate(); // アニメーションループを開始

        function init() {
            // シーン、カメラ、レンダラーの初期化
            scene = new THREE.Scene(); // 新しいシーンを作成
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20); // カメラの設定
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true }); // レンダラーの作成
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true; // XR（AR）を有効化
            document.body.appendChild(renderer.domElement); // レンダラーをDOMに追加

            // ARボタンを作成して追加
            document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] }));

            // 赤点のメッシュを作成
            redDot = new THREE.Mesh(
                new THREE.SphereGeometry(0.01, 16, 16), // 小さな球体を作成
                new THREE.MeshBasicMaterial({ color: 0xff0000 }) // 赤色のマテリアル
            );
            scene.add(redDot); // シーンに赤点を追加
            redDot.visible = false; // 初期状態では非表示

            // コントローラーの初期化
            controller = renderer.xr.getController(0); // コントローラーを取得
            controller.addEventListener('select', onSelect); // コントローラーのタッチイベントにリスナーを追加
            scene.add(controller); // シーンにコントローラーを追加
        }

        function onSelect() {
            // タッチイベントが発生した時の処理
            if (hitTestSource) {
                const hitTestResults = controller.getHitTestResults(hitTestSource); // ヒットテストの結果を取得
                if (hitTestResults.length) {
                    const hit = hitTestResults[0]; // 最初のヒットテスト結果を取得
                    const position = new THREE.Vector3(); // 位置を格納するベクトル
                    const quaternion = new THREE.Quaternion(); // 回転を格納するクォータニオン
                    hit.getPose(controller.matrixWorld, position, quaternion); // ヒットテストから位置と回転を取得

                    // モデルがまだ読み込まれていない場合、モデルを読み込む
                    if (!model) {
                        loadModel(position, quaternion); // モデルを読み込む
                    } else {
                        // モデルがすでに存在する場合、位置を更新
                        model.position.copy(position); // モデルの位置を更新
                        model.quaternion.copy(quaternion); // モデルの回転を更新
                    }
                }
            }
        }

        function loadModel(position, quaternion) {
            // モデルの読み込み
            const loader = new GLTFLoader();
            loader.load('cube_small.glb', function (gltf) {
                model = gltf.scene; // 読み込んだシーンをモデルとして格納
                model.position.copy(position); // モデルの位置を設定
                model.quaternion.copy(quaternion); // モデルの回転を設定
                scene.add(model); // シーンにモデルを追加
            }, undefined, function (error) {
                console.error('モデルの読み込みに失敗:', error); // エラーハンドリング
            });
        }

        function animate() {
            renderer.setAnimationLoop(render); // アニメーションループを設定
        }

        function render() {
            // レンダリング処理
            const session = renderer.xr.getSession(); // 現在のXRセッションを取得
            if (session) {
                const referenceSpace = session.referenceSpace; // リファレンススペースを取得
                session.requestHitTestSource({ space: referenceSpace }) // ヒットテストソースをリクエスト
                    .then(source => {
                        hitTestSource = source; // ヒットテストソースを保存
                    });
            }

            // コントローラーの位置を取得
            const controller = renderer.xr.getController(0);
            if (hitTestSource) {
                const hitTestResults = controller.getHitTestResults(hitTestSource); // ヒットテストの結果を取得
                if (hitTestResults.length) {
                    const hit = hitTestResults[0];
                    const position = new THREE.Vector3();
                    const quaternion = new THREE.Quaternion();
                    hit.getPose(controller.matrixWorld, position, quaternion); // ヒットテストから位置と回転を取得

                    // 赤点の位置を更新し、表示
                    redDot.position.copy(position); // 赤点の位置を更新
                    redDot.visible = true; // 赤点を表示
                } else {
                    redDot.visible = false; // ヒットしなかった場合は赤点を非表示
                }
            }

            renderer.render(scene, camera); // シーンをレンダリング
        }
    </script>
</body>
</html>





